Table of Contents
=================

   * [Concepts](#concepts)
      * [Process management](#process-management)
         * [Systemd](#systemd)
      * [Onboot](#onboot)
      * [Run mode](#run-mode)
      * [Run Modes with Process Management](#run-modes-with-process-management)
      * [Configurations (admin vs internal)](#configurations-admin-vs-internal)
   * [intelmqctl](#intelmqctl)
      * [Overview](#overview)
         * [Principles](#principles)
         * [Syntax](#syntax)
         * [Generic flags](#generic-flags)
      * [intelmqctl start action](#intelmqctl-start-action)
      * [intelmqctl stop action](#intelmqctl-stop-action)
      * [intelmqctl restart action](#intelmqctl-restart-action)
      * [intelmqctl reload action](#intelmqctl-reload-action)
      * [intelmqctl configtest action](#intelmqctl-configtest-action)
      * [intelmqctl status action](#intelmqctl-status-action)
      * [intelmqctl enable action](#intelmqctl-enable-action)
      * [intelmqctl disable action](#intelmqctl-disable-action)


# Concepts

## Process management

Process management on IntelMQ has two modes on this proposal: systemd and PID.
Changing on IntelMQ configuration the process management to PID will work as always worked before. Using systemd to do process management will rely on systemd to manage the IntelMQ.

**on defaults configuration:**
```
{
    ...
    "process_manager": "< pid / systemd >"
    ...
}
```

### Systemd

**Systemd Services:** In this proposal there are three types of systemd services templates files.

1. `<bot-module>.continuous.service`: these service template files are templates to be instantiated by intelmqctl for each bot module configured with `run_mode: continuous`.
2. `<bot-module>.scheduled.service`: these service template files are templates to be to be instantiated by crontab for each bot module configured with `run_mode: scheduled`.
3. `intelmq.scheduled_bots_onboot.service`: this service file exists in order to take care of the bots configured with `run_mode: scheduled` that need to be configured on crontab when operating system starts. Please note that this service MUST be executed only onboot and before crontab service.


## Onboot

An IntelMQ bot configured with onboot enabled will start automatically when operating system starts. This parameter is also commonly called "autostart".

```
    "abusech-domain-parser": {
        ...
        "parameters": {
            "onboot": true
        }
    }
```

## Run mode

Each bot can be configured with a specific run mode such as:
* **continuous:** bot will run and process messages indefinitely.
* **scheduled:** bot will start at the defined `schedule_time`, run one successfully time and then exit.

**on runtime configuration:**
```
    "abusech-domain-parser": {
        ...
        "parameters": {
            "run_mode": "< continuous / scheduled >"
        }
    }
```

**Schedule time parameter clarification:**
`schedule_time` is a parameter defined per each bot on runtime configuration which specify the scheduled time when the bot should run. This parameter needs to be defined using crontab syntax. Please note that this parameter is only applicable to bots configured as `scheduled` run_mode.



## Run Modes with Process Management

![architecture](https://s22.postimg.org/qdylth98x/intelmq_bots_management.png)


## Configurations (admin vs internal)

In a quick overview:
* **admin configurations** are the usual configurations that the sysadmin has access and use to configure IntelMQ and the bots
* **internal configurations** are the configurations automatically generated by intelmqctl after a specific action executed by sysadmin like `intelmq start <bot-id>`.

The main reason for this is because there is a need to keep the current and successfull state of the bots even if sysadmin change something wrongly which can put IntelMQ in an unstable situation. There are multiple scenarios to prove this but for the sake of the simplicity in this proposal, we only say that admin configurations are the usual ones and internal configurations will be a stable copy handled automatically by intelmqctl without any interference by sysadmin. Knowing that internal configurations MUST only be changed by intelmqctl, not manually, therefore these configuration files will be placed in files located on `/var/run/intelmq`.

In a nutshell, intelmqctl will always have a copy of the three main configuration files (runtime.conf, defaults.conf and pipeline.conf) and will use them to detect possible issues, such as, bots which are running but not being managed since they were removed manually from configuration files. Therefore, **in order to remove a bot from configurations, sysadmin MUST first to stop and then remove the configuration, not the opposite**.


### Technical Information (only for implementation clarification purposes):

In situations where intelmqctl detects some insconsitence between the internal configurations (which have the current running state) and the admin configurations, intelmqctl will require action from sysadmin. Also, in case intelmqctl is NOT being run on interactive mode, will be available the possibility to specify flags to automatically perform the actions without need interaction or even default behavior can be defined. Regarding the check procedure in order to detect the inconsistencies, intelmqctl will always perform the normal checks between internal runtime configuration and admin runtime configuration for all bots even if the `intelmqctl` command was executed just to only one bot. This checks will allow the sysadmin to be aware that something is wrong with the configuration even if sysadmin is executing other command with intelmqctl, therefore, a warning message will be available.


### IMPORTANT NOTE:

The checks which will be performed are hard to explain in this document... For the sake of simplicity, please lets assume that the checks will ALWAYS handle if bad things happen. Yes, we can discuss what and how to handle, but is not important now on this proposal. The **MAIN THING** here is: is a MUST to have this checks and is also a MUST to always have a stable configurations, lets keep in mind in all this document.


# intelmqctl

## Overview

### Principles

There are principles defined for `intelmqctl` in order to simplify this document and remove duplication of phrases and special notes for some cases, therefore `intelmqctl` will always:
* execute the bot background, not in foreground.
* provide the possibility to be executed in interaction mode or in non-interaction mode using flags.
* provide the best log message in order to give additional information to sysadmin about the actions performed. 
* check if there is any issue with configurations (runtime, defaults, pipeline) regarding all bots even if just one action to one bot has been executed.
 * in case a bot is running but some configuration for that bot is missing in one of the files, the action will not be performed and sysadmin will receive a warning message
 * intelmqctl will automatically re-add the missing configuration and ask to syadmin to re-run the command again, now with the configurations cleaned.


### Syntax
```
intelmqctl <action command> <bot_id> <flags>
```

### Generic flags

* `--filter`: this flag will provide to sysadmin a quick way to specify which bots this action will be apply. The filtering can be done using the configuration keys parameters as the following examples:

```
intelmqctl start --filter "run_mode:scheduled, group:Collectors"
```
```
intelmqctl stop --filter "run_mode:continuous, group:Outputs"
```

## intelmqctl start action

### Command

```
intelmqctl start <bot_id> <flags>
```

#### Specific flags

* `--oneshot`: this flag will execute the bot now and process successfully one message and then exit. This action MUST NOT taking into account `run_mode`.
* `--foreground`: this flag will execute the bot in foreground, showing the logs in the terminal window.
* `--schedule-exec`: this flag will execute the bot now and process successfully one message and then exit. This action **MUST only be used** to configure a scheduled bot on Crontab configuration and in a normal case an user don't need to be aware of it. Performing `intelmqctl start <bot-id>` where `bot-id` is a bot configured as scheduled will automatically put a new entry on Crontab with this flag `--schedule-exec`.

### Procedure

**> Bot is running:**
* will not perform any action


**> Bot configured with "Continuous" Run Mode and "PID" Process Manager:**
* intelmqctl will check if there is a PID file
* if PID file exists, do nothing
* if PID file does not exist, execute start action on bot and write PID file


**> Bot configured with "Continuous" Run Mode and "Systemd" Process Manager:**
* execute `systemctl start <bot-module>.continuous@<bot_id>.service`


**> Bot configured with "Scheduled" Run Mode and "PID" Process Manager:**
- intelmqctl will check if crontab configuration line for the bot is already on crontab:
- if crontab configuration line exists, do nothing. In the end, write a log message "bot is already scheduled"
- if crontab configuration line does not exists, add configuration line on crontab such as `<schedule_time> intelmqctl start <bot_id> --schedule-exec # <bot_id>`. In the end, write a log message "bot is schedule and will run at this time: `* * * * * `"


**> Bot configured with "Scheduled" Run Mode and "Systemd" Process Manager:**
- intelmqctl will check if crontab configuration line for the bot is already on crontab:
- if crontab configuration line exists, do nothing. In the end, write a log message "bot is already scheduled"
- if crontab configuration line does not exists, add configuration line on crontab such as `<schedule_time> systemctl start <bot-module>.scheduled@<bot_id>.service # <bot_id>`. In the end, write a log message "bot is schedule and will run at this time: `* * * * * `"


## intelmqctl stop action

### Command

```
intelmqct stop <bot_id> <flags>
```

### Procedure

* `intelmqctl` will not perform any action to a bot which is already stopped.
* if Run mode: continuous
  - if Process manager: PID
    - intelmqctl will check if there is a PID file
    - if PID file exists, execute stop action on the bot and remove PID file
    - if PID file does not exist, do nothing
  - if Process manager: systemd
    - execute `systemctl stop <bot-module>.continuous@<bot_id>.service`
* if Run mode: scheduled
  - if Process manager: PID or systemd
    - intelmqctl will check if crontab configuration line for the bot is still on crontab
    - if crontab configuration line exists, remove configuration line on crontab. In the end, write a log message "bot is unschedule."
    - if crontab configuration line does not exists, do nothing. In the end, write a log message "bot is already stopped"


## intelmqctl restart action

**Command:**

```
intelmqctl restart <bot_id> <flags>
```

**Procedure:**

* `intelmqctl` will use the stop action command and start action command to perform the restart, therefore, there is no additional information required here, is only to actions commands being executed already explained.



## intelmqctl reload action

**Command:**

```
intelmqctl reload <bot_id> <flags>
```

**Procedure:**

* `intelmqctl` will perform additional checks in order to handle some issues related to correct procedures which may not being followed by admin. The checks will be described in this section. 

* if `<bot_id>` has a new `run_mode` value AND `<bot_id>` is running:
  - raise message "`<bot_id>` is configured with a new `run_mode` therefore cannot be reload and it requires to be restarted in order to reload the new configuration. Do you want to restart the bot to apply the new `run_mode`? [Y/n]"
    - "[Y] `intelmqctl` will automatically execute restart action on the bot and the bot will start with the new configuration" \
    - "[N] `intelmqctl` will not perform any action, therefore bot will keep running in the current run state.
* else:
  * Run mode: continuous
    - Process manager: PID
      - intelmqctl will check if there is a PID file
      - if PID file exists, execute reload action on the bot
      - if PID file does not exist, do nothing
    - Process manager: systemd
      - execute `systemctl reload <bot-module>.continuous@<bot_id>.service` (this action will be automatically specified in systemd template service file)
  * Run mode: scheduled
    - Process manager: PID or systemd
      - intelmqctl will check if crontab configuration line for the bot is still on crontab:
        - if crontab configuration line exists, double check if is accordingly to the reload action: if it is, do not perform any action, if is wrong, fix it.
        - if crontab configuration line does not exists, add it and log a message explaining the update action.
      **Note**: if a scheduled bot is running the reload action will be ignored until the next bot execution.

**Please note** the above explanation is exemplifying an interactive mode of intelmqctl, however, there will be available additional parameters to automatically answer the questions which will allow to execute this command by scripts or other tools.


## intelmqctl configtest action

**Command:**
```
intelmqctl configtest <bot_id> <flags>
```

**Procedure:**

* there are 2 types of checks. check if json is ok and check if parameters of bots are ok.
 * for json check should give a generic message in case of something is failing saying "json is bad"
 * for bot check should give a generic message in case of something is failing saying "bot config is bad because ..."


## intelmqctl status action

**Command:**
```
intelmqctl status <bot_id> <flags>
```

**Procedure:**

* Run mode: continuous
  - Process manager: PID
    - intelmqctl will check if there is a PID file
      - if PID file exists, log message saying the current status is "running"
      - if PID file does not exists, log message saying the current status is "not running"
  - Process manager: systemd
    - execute `systemctl status <bot-module>.continuous@<bot_id>.service`
* Run mode: scheduled
  - Process manager: PID or systemd
    - intelmqctl will check if bot is configured on crontab
      - if configured on crontab, log message saying the current status is "scheduled"
      - if not configured on crontab, log message saying the current status is "not scheduled"

**Ouput Proposal Example 1:**

| bot_id    | run_mode    | scheduled_time (if applicable) | status             | onboot          | configtest   |
|-----------|-------------|--------------------------------|--------------------|-----------------|--------------|
| my-bot-1  | scheduled      | -                           | scheduled          | yes             | valid        |

Also intelmqctl should print the last 10 log lines from the log of this bot.

**Ouput Proposal Example 2:**

| bot_id    | run_mode    | scheduled_time (if applicable) | status             | onboot | configtest   |
|-----------|-------------|--------------------------------|--------------------|--------|--------------|
| my-bot-2  | continuous  | 1 * * * *                      | running (unstable) | no     | invalid      |

Also intelmqctl should print the last 10 log lines from the log of this bot.


## intelmqctl enable action

**Command:**
```
intelmqctl enable <bot_id> <flags>
```

**Procedure:**

* `intelmqctl` perform the usual checks and if no errors found, `intelmqctl` will configure the runtime configuration for the <bot_id> accordingly to the following procedure:

* Run mode: continuous
  - Process manager: PID
    - intelmqctl will not perform any action and will change `onboot` configuration parameter to `false` value.
    - In the end, write a log message "IntelMQ does not support onboot configuration in PID process management. Please use systemd process management"
  - Process manager: systemd
    - execute `systemctl enable <bot-module>.continuous@<bot_id>.service`
    - intelmqctl will change `onboot` configuration parameter to `true` value.
* Run mode: scheduled
  - Process manager: PID
    - intelmqctl will not perform any action and will change `onboot` configuration parameter to `false` value.
    - In the end, write a log message "IntelMQ does not support onboot configuration in PID process management. Please use systemd process management"
  - Process manager: systemd
    - intelmqctl will change `onboot` configuration parameter to `true` value.
    - intelmqctl will not perform any other action because there is a `intelmq.scheduled_bots_onboot.service` which is always enable and will automatically write the crontab configuration accordingly to the all bots configured as `run_mode: scheduled` and `onboot: true`, therefore will write on crontab configuration the correct crontab entry to this bot enabled onboot. For more information please read "Run Modes with Process Management concept" section.


## intelmqctl disable action

**Command:**
```
intelmqctl disable <bot_id> <flags>
```

**Procedure:**

* `intelmqctl` perform the usual checks and if no errors found, `intelmqctl` will configure the runtime configuration for the <bot_id> accordingly to the following procedure:

* Run mode: continuous
  - Process manager: PID
    - intelmqctl will not perform any action and will change `onboot` configuration parameter to `false` value.
    - In the end, write a log message "IntelMQ does not support onboot configuration in PID process management. Please use systemd process management"
  - Process manager: systemd
    - execute `systemctl disable <bot-module>.continuous@<bot_id>.service`
    - intelmqctl will change `onboot` configuration parameter to `false` value.
* Run mode: scheduled
  - Process manager: PID
    - intelmqctl will not perform any action and will change `onboot` configuration parameter to `false` value.
    - In the end, write a log message "IntelMQ does not support onboot configuration in PID process management. Please use systemd process management"
  - Process manager: systemd
    - intelmqctl will change `onboot` configuration parameter to `false` value.
    - intelmqctl will not perform any other action because there is a `intelmq.scheduled_bots_onboot.service` which is always enable and will automatically write the crontab configuration accordingly to the all bots configured as `run_mode: scheduled` and `onboot: true`, therefore will not write on crontab configuration anything related to this bot disabled onboot. For more information please read "Run Modes with Process Management concept" section.



# Discuss with Aaron

* Aaron: missing concept: every bot MUST have a self-test and stats-component. This can be used for the ctl tool to check if the internal state of a bot is OK.
 * Tomas: need clarification from Aaron
* Aaron: process manager is independent of run mode (in an abstract sense). Let's keep this separated.
 * Tomas: dont understand this comment. This comment is on a Process management section which does not mention anything about run modes. 
* Tomas: the "OnBoot Scheduled Bots Service" bubble in diagram is still required because if bot is configured as: `run_mode: scheduled`, `onboot: true` and sysadmin stopped the bot before the operating system restart, the bot will not start since was not in crontab.
* Aaron: too complicated. It tries to solve independent things at once in one document --> split it!
 * Tomas: they are not independent, I would say that is a really a challenge to describe one piece without mentioning other one or without having knowledge about other one. Also, its better for proposal purposes to have all info in one document... 
* Tomas: need to remember why is crutial to split `autostart` in `onboot` and `enable` parameters. (**Not applicable anymore since me and Aaron agreed that we don't care about a feature "Enabled" / "NeverRun" parameter to completely block the bot to start.**)
 * Tomas: if a bot is configured with `autostart: true` and `run_mode: scheduled`, the `intelmq.scheduled_bots_onboot.service` service will not be able to know if the bot is only active to be start or if really need to check on crontab during the boot of operating system if the crontab is configured to start the bot.
* Tomas: is really a requirement to have intelqmctl as a interface even in crontab configuration file because of PID files.... if we write python module for PID process management will create PID files so stills a problem. FIXME
